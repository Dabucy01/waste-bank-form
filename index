<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,Arial;background:#eef3f7;margin:0;padding:16px;font-size:20px}
    .card{background:#fff;border-radius:18px;padding:18px;max-width:560px;margin:0 auto;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .title{font-size:30px;font-weight:900;text-align:center;margin:6px 0 10px}
    .name{font-size:20px;text-align:center;color:#222;background:#f6f8fa;border-radius:14px;padding:10px;margin:10px 0 16px}
    .step{font-size:22px;font-weight:900;margin:16px 0 8px}
    .hint{font-size:18px;color:#444;margin:0 0 10px}
    .cameraBox{border:4px dashed #06c755;border-radius:16px;padding:14px;background:#f3fff7}
    input[type="file"]{width:100%;font-size:18px;padding:10px}
    .bigInput{width:100%;font-size:22px;padding:14px;border-radius:14px;border:2px solid #cfd6dd;box-sizing:border-box}
    .btn{width:100%;background:#06c755;color:#fff;border:0;border-radius:16px;font-size:24px;font-weight:900;padding:16px;margin-top:16px;cursor:pointer}
    .btn:disabled{background:#aaa}
    .btnSm{font-size:18px;padding:12px}
    .btnBlack{background:#111}
    .small{font-size:16px;color:#666;text-align:center;margin-top:10px;white-space:pre-wrap}
    .preview{max-width:100%;border-radius:12px;margin-top:10px;display:none}
    #loadingScreen{text-align:center;padding:10px 0}
    #loadMsg{font-size:14px;color:#555;margin-top:8px;white-space:pre-wrap;text-align:left;background:#f6f8fa;border-radius:12px;padding:10px;min-height:50px;line-height:1.6}
    #mainForm{display:none}
  </style>
</head>
<body>
<div class="card">
  <div class="title">üì¶ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞</div>

  <div id="loadingScreen">
    <div style="font-size:22px;font-weight:700">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    <div id="loadMsg">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>
    <button class="btn btnSm btnBlack" onclick="location.reload()" style="margin-top:12px">üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
    <button class="btn btnSm" onclick="openLiff()" style="margin-top:8px">üì± ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE</button>
  </div>

  <div id="mainForm">
    <div id="who" class="name">üë§ ...</div>

    <div class="step">üì∑ 1) ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Ç‡∏¢‡∏∞</div>
    <div class="hint">‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô "‡∏Ç‡∏¢‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÅ‡∏•‡∏∞ "‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡∏ï‡∏£‡∏≤‡∏ä‡∏±‡πà‡∏á" ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</div>
    <div class="cameraBox">
      <input id="photo" type="file" accept="image/*" capture="environment" onchange="previewPhoto(this)" />
      <img id="preview" class="preview" />
    </div>

    <div class="step">‚öñÔ∏è 2) ‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)</div>
    <div class="hint">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 1.50</div>
    <input id="weight" class="bigInput" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.50" step="0.01" min="0.01" />

    <button id="submitBtn" class="btn" onclick="submitData()">‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞</button>
    <div id="msg" class="small"></div>
  </div>
</div>

<script>
  const LIFF_ID  = "2009222279-hD8AGu5R";
  const LIFF_URL = "https://liff.line.me/" + LIFF_ID;
  let userId = "", displayName = "";

  function log(s) {
    document.getElementById("loadMsg").textContent += "\n" + s;
  }
  function openLiff() { location.href = LIFF_URL; }
  function showForm() {
    document.getElementById("loadingScreen").style.display = "none";
    document.getElementById("mainForm").style.display = "block";
  }
  function previewPhoto(input) {
    const p = document.getElementById("preview");
    if (input.files && input.files[0]) {
      p.src = URL.createObjectURL(input.files[0]);
      p.style.display = "block";
    }
  }

  (async () => {
    try {
      log("SDK ‚úÖ");
      log("init LIFF...");

      await Promise.race([
        liff.init({ liffId: LIFF_ID }),
        new Promise((_, rej) => setTimeout(() => rej(new Error("timeout 20s ‚Äî ‡∏•‡∏≠‡∏á‡∏Å‡∏î '‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô LINE'")), 20000))
      ]);

      log("init ‚úÖ  isInClient=" + liff.isInClient() + "  isLoggedIn=" + liff.isLoggedIn());

      if (!liff.isLoggedIn()) {
        log("‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect login...");
        liff.login({ redirectUri: LIFF_URL });
        return;
      }

      log("‡∏î‡∏∂‡∏á profile...");
      const p = await liff.getProfile();
      userId      = p.userId      || "";
      displayName = p.displayName || "";
      log("‚úÖ " + displayName);
      document.getElementById("who").textContent = "üë§ " + displayName;
      showForm();

    } catch (e) {
      log("‚ùå " + (e && e.message ? e.message : e));
    }
  })();

  async function submitData() {
    const weight = document.getElementById("weight").value;
    const file   = document.getElementById("photo").files[0];
    const msg    = document.getElementById("msg");
    const btn    = document.getElementById("submitBtn");
    msg.textContent = "";

    if (!file)                             { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô"); return; }
    if (!weight || parseFloat(weight) <= 0){ alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }
    if (!userId)                           { alert("‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà"); return; }

    btn.disabled = true;
    msg.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

    try {
      const form = new FormData();
      form.append("displayName", displayName);
      form.append("userId",      userId);
      form.append("weight",      weight);
      form.append("photo",       file, file.name || "photo");

      const gasBase = location.href.split("?")[0];
      const res = await fetch(gasBase, { method: "POST", body: form });
      const out = await res.json();

      if (out.ok) {
        alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö");
        if (liff.isInClient()) liff.closeWindow();
      } else {
        alert("‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (out.error || "unknown"));
        btn.disabled = false;
        msg.textContent = "";
      }
    } catch (e) {
      alert("‚ùå " + (e && e.message ? e.message : e));
      btn.disabled = false;
      msg.textContent = "";
    }
  }
</script>
</body>
</html>
