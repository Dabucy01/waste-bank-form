<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:system-ui;background:#eef3f7;margin:0;padding:16px}
.card{background:#fff;border-radius:18px;padding:20px;max-width:520px;margin:auto;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.title{font-size:26px;font-weight:900;text-align:center;margin-bottom:10px}
.name{text-align:center;background:#f5f7fa;padding:8px;border-radius:10px;margin-bottom:10px}
.step{font-weight:700;margin-top:10px}
input{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin-top:6px}
.btn{width:100%;background:#06c755;color:#fff;border:0;border-radius:14px;font-size:20px;font-weight:700;padding:14px;margin-top:16px}
.btn.loading{background:#999}
.loader{border:3px solid #eee;border-top:3px solid #06c755;border-radius:50%;width:22px;height:22px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:6px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
#status{text-align:center;margin-top:10px;font-size:14px}
.preview{max-width:100%;border-radius:12px;margin-top:10px;display:none}
</style>
</head>

<body>
<div class="card">
<div class="title">üì¶ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞</div>
<div id="who" class="name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

<div class="step">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
<input type="file" id="photo" accept="image/*" capture="environment">
<img id="preview" class="preview">

<div class="step">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</div>
<input type="number" id="weight" step="0.01">

<button id="submitBtn" class="btn" onclick="submitData()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<div id="status"></div>
</div>

<script>
const LIFF_ID="2009222279-hD8AGu5R";
const GAS_URL="https://script.google.com/macros/s/AKfycby89i23f9-_GlbxwhzQUJ_Ale-nctOoM86afx22DbvS0743R25ZDN_xePFYOyRMqYbC/exec";

let userId="",displayName="";

document.getElementById("photo").onchange=e=>{
const img=document.getElementById("preview");
img.src=URL.createObjectURL(e.target.files[0]);
img.style.display="block";
};

(async()=>{
await liff.init({liffId:LIFF_ID});
if(!liff.isLoggedIn()){liff.login();return;}
const p=await liff.getProfile();
userId=p.userId;
displayName=p.displayName;
document.getElementById("who").textContent="üë§ "+displayName;
})();

async function submitData(){
const file=document.getElementById("photo").files[0];
const weight=document.getElementById("weight").value;
const btn=document.getElementById("submitBtn");
const status=document.getElementById("status");

if(!file){alert("‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô");return;}
if(!weight){alert("‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å");return;}

btn.disabled=true;
btn.classList.add("loading");
btn.innerHTML='<span class="loader"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
status.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";

try{
const base64=await new Promise(res=>{
const r=new FileReader();
r.onload=()=>res(r.result);
r.readAsDataURL(file);
});

const payload={
displayName,
userId,
weightKg:Number(weight),
imageData:base64
};

const body=new URLSearchParams();
body.append("payload",JSON.stringify(payload));

await fetch(GAS_URL,{method:"POST",body});

status.textContent="‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
btn.innerHTML="‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";

setTimeout(()=>{
if(liff.isInClient()) liff.closeWindow();
},800);

}catch(e){
status.textContent="‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
btn.disabled=false;
btn.classList.remove("loading");
btn.innerHTML="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
}
}
</script>
</body>
</html>
