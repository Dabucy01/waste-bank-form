<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{font-family:system-ui,Arial;background:#eef3f7;margin:0;padding:16px;font-size:18px}
    .card{background:#fff;border-radius:18px;padding:18px;max-width:520px;margin:0 auto;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .title{font-size:26px;font-weight:900;text-align:center;margin:6px 0 12px}
    .name{font-size:18px;text-align:center;color:#222;background:#f6f8fa;border-radius:12px;padding:8px;margin-bottom:12px}
    .step{font-size:18px;font-weight:700;margin-top:10px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #ccc;margin-top:6px;font-size:16px}
    .btn{width:100%;background:#06c755;color:#fff;border:0;border-radius:14px;font-size:20px;font-weight:700;padding:14px;margin-top:16px}
    .btn:disabled{opacity:.7}
    .preview{max-width:100%;border-radius:12px;margin-top:10px;display:none}
    #status{margin-top:10px;text-align:center;font-size:14px;color:#333;min-height:20px}
  </style>
</head>

<body>
<div class="card">
  <div class="title">üì¶ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞</div>

  <div id="who" class="name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <div class="step">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Ç‡∏¢‡∏∞</div>
  <input type="file" id="photo" accept="image/*" capture="environment" />
  <img id="preview" class="preview" />

  <div class="step">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</div>
  <input type="number" id="weight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.50" step="0.01" />

  <button class="btn" id="submitBtn" onclick="submitData()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <div id="status"></div>
</div>

<script>
const LIFF_ID = "2009222279-hD8AGu5R";
const GAS_URL = "https://script.google.com/macros/s/AKfycby89i23f9-_GlbxwhzQUJ_Ale-nctOoM86afx22DbvS0743R25ZDN_xePFYOyRMqYbC/exec";

let userId = "";
let displayName = "";

document.getElementById("photo").onchange = (e) => {
  const img = document.getElementById("preview");
  if (e.target.files && e.target.files[0]) {
    img.src = URL.createObjectURL(e.target.files[0]);
    img.style.display = "block";
  }
};

(async () => {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) { liff.login(); return; }
  const p = await liff.getProfile();
  userId = p.userId;
  displayName = p.displayName;
  document.getElementById("who").textContent = "üë§ " + displayName;
})();

async function submitData(){
  const file = document.getElementById("photo").files[0];
  const weightStr = document.getElementById("weight").value;
  const weightNum = Number(weightStr);

  const btn = document.getElementById("submitBtn");
  const statusEl = document.getElementById("status");

  if(!file){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ"); return; }
  if(!weightStr || !(weightNum > 0)){ alert("‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }

  // UI: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á
  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
  statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

  try{
    const base64 = await new Promise((res, reject) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    const payload = {
      displayName,
      userId,
      weightKg: weightNum,
      imageData: base64
    };

    const body = new URLSearchParams();
    body.append("payload", JSON.stringify(payload));

    const resp = await fetch(GAS_URL, { method:"POST", body });

    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏•‡∏±‡∏ö ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡πÄ‡∏ä‡πá‡∏Ñ resp.ok
    let ok = true;
    try{
      const j = await resp.json();
      ok = !!j.ok;
      if(!ok) throw new Error(j.error || "unknown_error");
    }catch(_){
      if (!resp.ok) throw new Error("http_error_" + resp.status);
    }

    // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó LINE (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°)
    try{
      if (liff.isInClient() && typeof liff.sendMessages === "function") {
        await liff.sendMessages([{
          type: "text",
          text: `‡∏ù‡∏≤‡∏Å‡∏Ç‡∏¢‡∏∞ ${weightNum.toFixed(2)} ‡∏Å‡∏Å. ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ`
        }]);
      }
    } catch(_) {}

    // UI: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    statusEl.textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
    btn.textContent = "‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß";

    setTimeout(()=>{
      if(liff.isInClient()) liff.closeWindow();
    }, 700);

  }catch(e){
    statusEl.textContent = "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e && e.message ? e.message : e);
    btn.disabled = false;
    btn.textContent = oldText;
  }
}
</script>
</body>
</html>
